(function(e){var t,n=e.Backbone,r=e._,i=e.$,s=n.View.prototype._configure,o=n.View.prototype.render,u=n.View.extend({constructor:function(t){t=t||{},u.setupView(this,t),n.View.call(this,t)},swapLayout:function(e){return e.views=r.defaults({},this.views,e.views),e.setElement(this.el),e},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return r.each(e,function(t,n){e[n]=[].concat(t)}),this.setViews(e)},getView:function(e){return this.getViews(e).first().value()},getViews:function(e){var t=r.chain(this.views).map(function(e){return[].concat(e)},this).flatten().value();return r.chain(r.filter(t,e?e:r.identity))},setView:function(e,t,n){var i,s,o=this;r.isString(e)||(n=t,t=e,e=""),this.views=this.views||{},!n&&this.views[e]&&(r.isArray(this.views[e])?r.each(this.views[e],function(e){e.remove()}):this.views[e].remove());if(!t.__manager__)throw new Error("manage property not set.  http://tbranyen.github.com/backbone.layoutmanager/#usage/structuring-a-view");return s=t._options(),t.render=function(i){function l(){(!n||t.keep||!f.hasRendered)&&s.partial(o.el,e,t.el,n),t.delegateEvents(),f.handler&&(f.handler.resolveWith(t,[t.el]),delete f.handler),a.resolveWith(t,[t.el]),r.isFunction(i)&&i.call(t,t.el)}var a=s.deferred(),f=t.__manager__;return f.viewDeferred=a,t._removeViews(),u.prototype.render.call(t).then(l),a.promise()},t.__manager__.parent=o,t.__manager__.selector=e,n?(i=this.views[e]=this.views[e]||[],r.isArray(this.views[e])||(i=this.views[e]=[this.views[e]]),r.indexOf(i,t)>-1?t:(i.push(t),t.__manager__.append=!0,t)):this.views[e]=t},setViews:function(e){return r.each(e,function(e,t){if(r.isArray(e))return r.each(e,function(e){this.insertView(t,e)},this);this.setView(t,e)},this),this},render:function(e){var t,n=this,i=this._options(),s=i.deferred(),o=this.__manager__;return o.renderDeferred?(o.callback=e,o.renderDeferred):(o.renderDeferred=s,this._render(u._viewRender).fetch.then(function(){var e=r.map(n.views,function(e){function n(e,t){if(!e.length)return t();var r=e.shift();r.render(function(){n(e,t)})}var t;return r.isArray(e)?(t=i.deferred(),n(r.clone(e),function(){t.resolve()}),t.promise()):e.render()});i.when(e).then(function(){s.resolveWith(n,[n.el])})}),t=s.then(function(){r.isFunction(e)&&e.call(n,n.el),n.__manager__.handler&&(n.__manager__.handler.resolveWith(n,[n.el]),delete n.__manager__.handler),r.isFunction(n.__manager__.callback)&&(n.__manager__.callback.call(n,n.el),delete n.__manager__.callback),delete n.__manager__.renderDeferred}),r.defaults(t,n))},remove:function(){return u._removeView(this,!0),this._remove.apply(this,arguments)},_options:function(){return r.extend({},this,u.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e){function o(n,r){u.cache(t,r),r&&s.html(e.el,s.render(r,n)),i.fetch.resolveWith(e,[e.el])}var t,n,i,s=e._options();return{render:function(a){var f=e.__manager__,l=e.template||s.template;return e.serialize&&(s.serialize=e.serialize),!a&&r.isFunction(s.serialize)?a=s.serialize.call(e):!a&&r.isObject(s.serialize)&&(a=s.serialize),i=u._makeAsync(s,r.bind(o,e,a)),i.fetch=s.deferred(),f.handler=i,r.isString(l)&&(t=f.prefix+l),(n=u.cache(t))?(o(a,n,t),i):(r.isString(l)?n=s.fetch.call(i,f.prefix+l):l!=null&&(n=s.fetch.call(i,l)),i._isAsync||o(a,n),i)}}},cleanViews:function(e){r.each([].concat(e),function(e){e.unbind(),e.views&&r.each(e.views,function(e){u.cleanViews(e)}),r.isFunction(e.cleanup)&&e.cleanup.call(e)})},cache:function(e,t){if(e in this._cache)return this._cache[e];if(e!=null&&t!=null)return this._cache[e]=t},configure:function(e){r.extend(u.prototype.options,e),e.manage&&(n.View.prototype.manage=!0)},setupView:function(e,i){var s,o,a=n.LayoutManager.prototype,f=r.pick(e,t);if(e.__manager__)return;r.defaults(e,{views:{},__manager__:{},_options:u.prototype._options,_removeViews:u._removeViews,_removeView:u._removeView}),e instanceof n.Layout?e.__manager__.prefix=e._options().paths.layout||"":e.__manager__.prefix=e._options().paths.template||"",i=e.options=r.defaults(i||{},e.options,a.options),o=r.pick(i,["events"].concat(r.values(i.events))),r.extend(e,o),delete f.render,r.extend(i,f),e._remove=n.View.prototype.remove,e._render=function(e){var t,n=this._options().beforeRender,s=this._options().afterRender;return this._removeViews(),r.isFunction(n)&&n.call(this,this),this.trigger("beforeRender",this),t=e(this).render(),t.then(function(){var e=this,t=e.__manager__,n=t.parent,o=function(){e.delegateEvents(),e.__manager__.hasRendered=!0,r.isFunction(s)&&s.call(e,e),e.trigger("afterRender",e)},u=function(e){var t=e.__manager__;return t.parent&&!t.parent.__manager__.hasRendered?t.parent:e};if(!n)return o.call(e);if(n.__manager__.hasRendered)return i.when([t.viewDeferred,n.__manager__.viewDeferred]).then(function(){o.call(e)});n=u(e),n.on("afterRender",function(){n.off(null,null,e),o.call(e)},e)}),t},e.render=u.prototype.render,e.remove!==a.remove&&(e._remove=e.remove,e.remove=a.remove),s=i.views||e.views,r.keys(s).length&&e.setViews(s),e.template&&(i.template=e.template,delete e.template)},_removeViews:function(e){e=e||this,e.getViews().each(function(e){u._removeView(e,!0)})},_removeView:function(e,t){var n=e.__manager__,i=r.isBoolean(e.keep)?e.keep:e.options.keep;t=t&&n.parent,u.cleanViews(e);if(!i&&(n.append===!0||t)&&n.hasRendered){e.$el.remove();if(r.isArray(n.parent.views[n.selector]))return n.parent.getView(function(e,t){e.__manager__===n&&n.parent.views[n.selector].splice(t,1)});delete n.parent.views[n.selector]}}});r.each(["get","set","insert"],function(e){var t=n.View.prototype,r=u.prototype;t[e+"View"]=r[e+"View"],t[e+"Views"]=r[e+"Views"]}),n.Layout=n.LayoutManager=u,n.LayoutView=n.View.extend({manage:!0}),n.View.prototype._configure=function(){var e=s.apply(this,arguments);return this.manage&&u.setupView(this),e},u.prototype.options={paths:{},deferred:function(){return i.Deferred()},fetch:function(e){return r.template(i(e).html())},partial:function(e,t,n,r){var s=t?i(e).find(t):i(e);return s.length?(this[r?"append":"html"](s,n),!0):!1},html:function(e,t){i(e).html(t)},append:function(e,t){i(e).append(t)},when:function(e){return i.when.apply(null,e)},render:function(e,t){return e(t)}},t=r.keys(u.prototype.options)})(this),define("plugins/backbone.layoutmanager",function(){}),define("zeega",["plugins/backbone.layoutmanager"],function(){var e={root:"/"},t=window.JST=window.JST||{};return Backbone.LayoutManager.configure({manage:!1,paths:{layout:"app/templates/layouts/",template:"app/templates/"},fetch:function(n){var r;return n+=".html",t[n]?t[n]:(r=this.async(),$.ajax({url:e.root+n}).then(function(e){r(t[n]=_.template(e))}))}}),_.extend(e,{module:function(e){return _.extend({Views:{}},e)},useLayout:function(e,t){if(this.layout&&this.layout.options.template===e)return this.layout;this.layout&&this.layout.remove();var n=new Backbone.Layout(_.extend({template:e,className:"layout "+e,id:"layout"},t));return $("#main").empty().append(n.el),n.render(),this.layout=n,n}},Backbone.Events)}),define("zeega_layers/_layer/_layer",["plugins/backbone.layoutmanager"],function(){return _Layer=Backbone.Model.extend({layerType:null,controls:[],defaults:{hasControls:!0,defaultControls:!0,showCitation:!0},defaultAttributes:{},initialize:function(){this.init()},init:function(){},player_onPreload:function(){},player_onPlay:function(){},player_onPause:function(){},player_onExit:function(){},player_onUnrender:function(){},player_onRenderError:function(){},editor_onLayerEnter:function(){},editor_onLayerExit:function(){},editor_onControlsOpen:function(){},editor_onControlsClosed:function(){}}),_Layer.Visual=Backbone.LayoutView.extend({className:"visual-element",draggable:!0,template:"",initialize:function(){this.init()},beforeRender:function(){$(".ZEEGA-player-window").append(this.el),this.applySize()},applySize:function(){this.$el.css({width:this.getAttr("width")+"%"})},init:function(){},render:function(){},verifyReady:function(){this.model.trigger("ready",this.model.id)},player_onPreload:function(){this.verifyReady()},player_onPlay:function(){},player_onPause:function(){},player_onExit:function(){},player_onUnrender:function(){},player_onRenderError:function(){},editor_onLayerEnter:function(){},editor_onLayerExit:function(){},editor_onControlsOpen:function(){},editor_onControlsClosed:function(){},play:function(){this.isPlaying=!0,this.player_onPlay()},pause:function(){this.isPlaying=!1,this.player_onPause()},playPause:function(){console.log("play pause layer",this),this.isPlaying!==!1?(this.isPlaying=!1,this.player_onPause()):(this.isPlaying=!0,this.player_onPlay())},getAttr:function(e){return this.model.get("attr")[e]}}),_Layer}),define("zeega_layers/image/image",["zeega","zeega_layers/_layer/_layer"],function(e,t){var n=e.module();return n.Image=t.extend({layerType:"Image",defaultAttributes:{title:"Image Layer",url:"none",left:0,top:0,height:100,width:100,opacity:1,aspect:1.33,citation:!0,linkable:!0},controls:[{type:"checkbox",property:"dissolve",label:"Fade In"},{type:"slider",property:"width",label:"Scale",suffix:"%",min:1,max:200},{type:"slider",property:"opacity",label:"Scale",step:.01,min:.05,max:1}]}),n.Image.Visual=t.Visual.extend({template:"plugins/image",serialize:function(){return this.model.toJSON()},verifyReady:function(){var e=this,t=this.$el.imagesLoaded();t.done(function(){e.model.trigger("ready",e.model.id)}),t.fail(function(){e.model.trigger("error",e.model.id)})}}),n}),define("zeega_layers/_all",["zeega_layers/image/image"],function(e){var t={};return _.extend(t,e),t}),define("player/layer",["zeega","zeega_layers/_all"],function(e,t){var n=e.module(),r=Backbone.Model.extend({ready:!1,status:"waiting",defaults:{},initialize:function(){if(t[this.get("type")]){this.layerClass=t[this.get("type")];var e=_.defaults(this.toJSON(),this.layerClass.defaults);this.set(e)}},render:function(){this.layerClass&&(this.visualElement=new this.layerClass.Visual({model:this,attributes:{id:"visual-element-"+this.id,"data-layer_id":this.id}}),this.visualElement.render())},remove:function(){this.layerClass&&this.visualElement.remove()},destroy:function(){this.status!="waiting"&&this.status!="destroyed"&&(console.log("layer destroyed",this.id,this,this.status),this.status="destroyed")}});return n.Collection=Backbone.Collection.extend({model:r,initialize:function(){}}),n}),define("player/frame",["zeega","player/layer"],function(e,t){var n=e.module(),r=Backbone.Model.extend({ready:!1,status:"waiting",hasPlayed:!1,defaults:{attr:{advance:0},common_layers:{},layers:[],link_to:[],link_from:[],next:null,prev:null},getNext:function(){return this.get("next")},getPrev:function(){return this.get("prev")},setConnections:function(){!_.isNull(this.get("prev"))&&!_.isNull(this.get("next"))?this.set("connections","lr"):!_.isNull(this.get("prev"))&&_.isNull(this.get("next"))?this.set("connections","l"):_.isNull(this.get("prev"))&&!_.isNull(this.get("next"))?this.set("connections","r"):this.set("connections","none")},render:function(e){var t=this,n=this.get("common_layers")[e]||[];t.status=="ready"?this.layers.each(function(e){_.include(n,e.id)||e.render()}):this.layers.each(function(e){e.status=="waiting"&&!_.include(n,e.id)&&(e.on("ready",t.onLayerReady,t),e.render())})},onLayerReady:function(e){var t=getLayerStates();t.ready.length==this.layers.length&&(this.ready=!0);var n=this.layers.map(function(e){return e.status})},getLayerStates:function(){var e={};return e.ready=_.filter(_.toArray(this.layers),function(e){return e.status=="ready"}),e.waiting=_.filter(_.toArray(this.layers),function(e){return e.status=="waiting"}),e.loading=_.filter(_.toArray(this.layers),function(e){return e.status=="loading"}),e.destroyed=_.filter(_.toArray(this.layers),function(e){return e.status=="destroyed"}),e},unrender:function(e){var t=this.get("common_layers")[e]||[];this.layers.each(function(e){_.include(t,e.id)||e.remove()})},destroy:function(){this.status!="waiting"&&this.status!="destroyed"&&(this.layers.each(function(e){e.destroy()}),this.status="destroyed")}});return n.Collection=Backbone.Collection.extend({model:r,load:function(e,n){var r=this,i=new t.Collection(n);this.each(function(n){var r=[];n.layers=new t.Collection,_.each(n.get("layers"),function(e){n.layers.add(i.get(e))}),_.each(e,function(e){if(e.frames.length>1){var t=_.indexOf(e.frames,n.id);if(t>-1){var r=e.frames[t-1]||null,i=e.frames[t+1]||null;n.set({prev:r,next:i}),n.setConnections()}}});var s=n.layers.where({type:"Link"}),o=[],u=[];_.each(s,function(e){e.get("attr").from_frame==n.id?o.push(e.get("attr").to_frame):(n.layers.remove(e),u.push(e.get("attr").from_frame))}),n.set({link_to:o,link_from:u})}),this.each(function(e){var t={},n=_.uniq(_.compact(_.union(e.get("prev"),e.get("next"),e.get("link_to"),e.get("link_from"))));_.each(n,function(n){t[n]=_.intersection(e.layers.pluck("id"),r.get(n).layers.pluck("id"))}),e.set({common_layers:t})})}}),n}),define("player/player",["zeega","player/frame"],function(e,t){Player=Backbone.Model.extend({ready:!1,complete:!1,initialized:!1,status:"paused",currentFrame:null,defaults:{autoplay:!0,chromeless:!0,delay:0,escapable:!0,fade_overlays:!0,fadeIn:500,fadeOut:500,fullscreenEnable:!0,keyboard:!0,mode:"standalone",overlays:{arrows:!0,branding:!0,citations_layer:!0,citations_frame:!0,citations_project:!0,social:!0},start_frame:null,window_fit:!1,window_ratio:4/3},initialize:function(e){_.isUndefined(e)||this.load(e)},load:function(e){if(!this.initialized)if(e&&e.data&&_.isObject(e.data))this.set(e),n(this);else if(e&&e.url&&_.isString(e.url)){var t=this;this.url=e.url,this.set(e),this.fetch({silent:!0}).success(function(){n(t)}).error(function(){t.onError("3 - fetch error. bad url?")})}else this.onError("1 - invalid or missing data");else this.onError("2 - already loaded")},render:function(){var e=this;this.Layout=new r({model:this,attributes:{id:"ZEEGA-player-"+this.id,"data-projectID":this.id}}),$("body").append(this.Layout.el),this.Layout.render(),this.Layout.$el.fadeIn(this.get("fadeIn"),function(){e.onRendered()})},onRendered:function(){this.ready=!0,this.initEvents(),this.trigger("ready"),this.get("autoplay")&&this.play()},initEvents:function(){var e=this;this.get("keyboard")&&$(window).keyup(function(t){switch(t.which){case 27:e.get("escapable")&&e.destroy();break;case 37:e.cuePrev();break;case 39:e.cueNext();break;case 32:e.playPause()}})},play:function(){this.ready?this.status=="paused"&&(this.trigger("play"),_.isNull(this.currentFrame)&&_.isNull(this.get("start_frame"))?this.cueFrame(this.get("sequences")[0].frames[0]):_.isNull(this.currentFrame)&&!_.isNull(this.get("start_frame"))&&this.frames.get(this.get("start_frame"))?this.cueFrame(this.get("start_frame")):!_.isNull(this.currentFrame)||this.onError("3 - could not play")):this.render()},pause:function(){this.status=="playing"&&this.trigger("pause")},playPause:function(){console.log("play pause")},cueNext:function(e){this.cueFrame(this.currentFrame.get("next"),e)},cuePrev:function(e){this.cueFrame(this.currentFrame.get("prev"),e)},cueFrame:function(e,t){if(!_.isUndefined(e)&&!_.isUndefined(this.frames.get(e))){var n=this,r=t||0;r!==0?_.delay(function(){n.goToFrame(e)},r):this.goToFrame(e)}},goToFrame:function(t){console.log("gotoframe",t);var n;this.currentFrame&&(this.currentFrame.unrender(t),n=this.currentFrame.id),this.currentFrame=this.frames.get(t),this.currentFrame.render(n),e.router.navigate("/frame/"+t)},getMetadata:function(){return!1},getCitations:function(){return!1},getProjectTree:function(){return!1},destroy:function(){var e=this;this.Layout.$el.fadeOut(this.get("fadeOut"),function(){e.frames.each(function(e){e.destroy()}),e.trigger("player_destroyed")})},onError:function(e){this.trigger("error",e),alert("Error code: "+e)}});var n=function(e){var n=new t.Collection(e.get("frames"));n.load(e.get("sequences"),e.get("layers")),e.frames=n,e.initialized=!0,e.trigger("data_loaded"),e.get("autoplay")&&e.play()},r=Backbone.Layout.extend({template:"player-layout",className:"ZEEGA-player",initialize:function(){var e=this,t=_.debounce(function(){e.resizeWindow()},300);$(window).resize(t)},serialize:function(){return this.model.toJSON()},afterRender:function(){this.$(".ZEEGA-player-window").css(this.getWindowSize())},resizeWindow:function(){var e=this.getWindowSize();this.$(".ZEEGA-player-window").animate(e),this.model.trigger("window_resized",e)},getWindowSize:function(){var e={},t=window.innerWidth,n=window.innerHeight,r=t/n;return this.model.get("window_fit")?r>this.model.get("window_ratio")?(e.width=t+"px",e.height=t/this.model.get("window_ratio")+"px"):(e.width=n*this.model.get("window_ratio")+"px",e.height=n+"px"):r>this.model.get("window_ratio")?(e.width=n*this.model.get("window_ratio")+"px",e.height=n+"px"):(e.width=t+"px",e.height=t/this.model.get("window_ratio")+"px"),e}});return e.player=Player,window.Zeega=window.Zeega||e,$(window).trigger("zeega_ready"),Player}),define("router",["zeega","player/player"],function(e,t){var n=Backbone.Router.extend({routes:{"":"index","frame/:frameID":"goToFrame"},index:function(){var e=new t;e.on("all",function(e){console.log("e:",e)}),e.load({url:"http://alpha.zeega.org/api/projects/1841"}),console.log("project",e)},goToFrame:function(e){var n=new t;n.on("all",function(e){console.log("e:",e)}),n.load({url:"http://alpha.zeega.org/api/projects/1841",start_frame:parseInt(e,10)}),console.log("project",n,"go to frame",e)}});return n}),require(["zeega","router"],function(e,t){e.router=new t,Backbone.history.start({pushState:!0,root:e.root}),$(document).on("click","a:not([data-bypass])",function(t){var n={prop:$(this).prop("href"),attr:$(this).attr("href")},r=location.protocol+"//"+location.host+e.root;n.prop&&n.prop.slice(0,r.length)===r&&(t.preventDefault(),Backbone.history.navigate(n.attr,!0))})}),define("main",function(){}),require.config({deps:["main"],paths:{libs:"../assets/js/libs",plugins:"../assets/js/plugins",vendor:"../assets/vendor",player:"../app/modules/player",zeega_plugins:"../app/modules/plugins",zeega_layers:"../app/modules/plugins/layers"}}),define("config",function(){});